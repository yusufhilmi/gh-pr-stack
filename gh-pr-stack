#!/usr/bin/env bash
set -e

# Colors
GREEN='\033[32m'
RED='\033[31m'
PURPLE='\033[35m'
CYAN='\033[36m'
ORANGE='\033[38;5;208m'
RESET='\033[0m'

# Fetch all open PRs (including drafts) with relevant fields
prs=$(gh pr list --state open --json number,headRefName,baseRefName,url,isDraft,additions,deletions,changedFiles --limit 200)

# Collect all head branch names (branches that have a PR)
head_branches=$(echo "$prs" | jq -r '[.[].headRefName] | unique | .[]')

# Find root base branches: bases that are NOT the head of any open PR
# These are the true roots of PR stacks (e.g., main, staging if no PR targets it)
root_bases=$(echo "$prs" | jq -r --argjson heads "$(echo "$prs" | jq '[.[].headRefName] | unique')" \
    '[.[].baseRefName] | unique | map(select(. as $b | $heads | index($b) | not)) | .[]')

echo -e "\n===== OPEN PR STACKS =====\n"

# Track printed PR numbers to avoid duplicates
printed_file=$(mktemp)
trap "rm -f $printed_file" EXIT

# Function to print PRs recursively
print_pr_stack() {
    local base_branch="$1"
    local indent="$2"

    # Count how many PRs target this base branch
    local child_count
    child_count=$(echo "$prs" | jq --arg base "$base_branch" '[.[] | select(.baseRefName == $base)] | length')

    local index=0
    echo "$prs" | jq -r --arg base "$base_branch" \
        '.[] | select(.baseRefName == $base) | "\(.number)\t\(.url)\t\(.headRefName)\t\(.baseRefName)\t\(.isDraft)\t\(.additions)\t\(.deletions)\t\(.changedFiles)"' | \
    while IFS=$'\t' read -r number url head base is_draft additions deletions changed_files; do
        # Skip if already printed
        if grep -qx "$number" "$printed_file" 2>/dev/null; then
            continue
        fi
        echo "$number" >> "$printed_file"

        # Add empty line between siblings when there are 2+ children (not before first)
        if [ "$child_count" -ge 2 ] && [ "$index" -gt 0 ]; then
            echo ""
        fi
        index=$((index + 1))

        draft_indicator=""
        if [ "$is_draft" = "true" ]; then
            draft_indicator=" ${ORANGE}[DRAFT]${RESET}"
        fi

        # Line 1: +123 −45 (3 files)
        echo -e "${indent}${GREEN}+${additions}${RESET} ${RED}−${deletions}${RESET} ${ORANGE}(${changed_files} files)${RESET}"
        # Line 2: base <- head [DRAFT]
        echo -e "${indent}${PURPLE}${base}${RESET} <- ${head}${draft_indicator}"
        # Line 3: URL (same indentation)
        echo -e "${indent}${CYAN}${url}${RESET}"
        # Recursively find PRs targeting this PR's head branch
        print_pr_stack "$head" "${indent}   "
        # Add empty line after root-level PR trees for readability
        if [ -z "$indent" ]; then
            echo ""
        fi
    done
}

# Print stacks starting from each root base branch
for base in $root_bases; do
    print_pr_stack "$base" ""
done

# Check for any PRs that weren't printed (disconnected/orphan PRs)
total_prs=$(echo "$prs" | jq 'length')
printed_count=$(wc -l < "$printed_file" | tr -d ' ')

if [ "$printed_count" -lt "$total_prs" ]; then
    echo -e "===== STANDALONE PRs =====\n"
    echo "$prs" | jq -r '.[] | "\(.number)\t\(.url)\t\(.headRefName)\t\(.baseRefName)\t\(.isDraft)\t\(.additions)\t\(.deletions)\t\(.changedFiles)"' | \
    while IFS=$'\t' read -r number url head base is_draft additions deletions changed_files; do
        if grep -qx "$number" "$printed_file" 2>/dev/null; then
            continue
        fi
        echo "$number" >> "$printed_file"

        draft_indicator=""
        if [ "$is_draft" = "true" ]; then
            draft_indicator=" ${ORANGE}[DRAFT]${RESET}"
        fi

        echo -e "${GREEN}+${additions}${RESET} ${RED}−${deletions}${RESET} ${ORANGE}(${changed_files} files)${RESET}"
        echo -e "${PURPLE}${base}${RESET} <- ${head}${draft_indicator}"
        echo -e "${CYAN}${url}${RESET}"
        echo ""
    done
fi
